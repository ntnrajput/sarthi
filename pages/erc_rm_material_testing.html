<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SARTHI - ERC Raw Material Chemical Analysis</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- AOS -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <!-- Custom CSS -->
  <link href="../assets/css/styles.css" rel="stylesheet">

  <style>
    .page-content {
      padding-bottom: 5rem; /* Prevent footer overlap */
    }
    .form-container {
      max-width: 1000px;
      margin: 0 auto;
    }
    .out-of-range {
      background-color: #ffb3b3 !important; /* Light red */
    }
    .ref-text {
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>
  <!-- ✅ Navbar -->
  <div id="navbar-container"></div>

  <!-- 🧾 Main Content -->
  <div class="container page-content py-4">
    <div class="form-container">
      <h1 class="h3 mb-4 text-center" data-aos="fade-up">
        ERC Raw Material - Chemical Analysis
      </h1>

      <!-- 📘 Reference Section -->
      <div class="mb-4" data-aos="fade-up" data-aos-delay="100">
        <label class="form-label fw-semibold">Reference</label>
        <div class="alert alert-info mb-0">
          Cl. No. 7.1 with 4.3.1 & 4.3.2 of IRS T-31-2025 (Required 2 samples per lot)
        </div>
      </div>

      <!-- 🧪 Number of Lots -->
      <div class="mb-4" data-aos="fade-up" data-aos-delay="150">
        <label for="lotCount" class="form-label fw-semibold">No. of Lots</label>
        <input type="number" class="form-control" id="lotCount" placeholder="Enter No. of Lots">
      </div>

      <!-- 🧪 Tables Container -->
      <div id="tablesContainer"></div>

      <!-- 📝 Remarks -->
      <div class="mt-4 mb-4" data-aos="fade-up" data-aos-delay="300">
        <label for="remarks" class="form-label fw-semibold">Remarks</label>
        <textarea class="form-control" id="remarks" rows="3" placeholder="Enter any remarks..."></textarea>
      </div>

      <!-- 💾 Submit -->
      <div class="d-flex justify-content-center mb-5">
        <button type="button" class="btn btn-primary px-5" id="submitChemical">
          Save Analysis
        </button>
      </div>
    </div>
  </div>

  <!-- 📌 Footer -->
  <footer class="border-top py-3 mt-4 text-center small text-muted">
    © SARTHI - QIMS — v0.1
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    AOS.init({ duration: 800, once: true });

    const lotInput = document.getElementById('lotCount');
    const tablesContainer = document.getElementById('tablesContainer');

    // ✅ Tolerance ranges for chemical analysis
    const tolerance = {
      C: { min: 0.50, max: 0.60 },
      Si: { min: 1.50, max: 2.00 },
      Mn: { min: 0.80, max: 1.00 },
      P: { max: 0.030 },
      S: { max: 0.030 }
    };

    lotInput.addEventListener('input', () => {
      const lotCount = parseInt(lotInput.value) || 0;
      tablesContainer.innerHTML = '';

      for (let lot = 1; lot <= lotCount; lot++) {
        const table = document.createElement('div');
        table.className = 'mb-4';
        table.innerHTML = `
          <h5 class="mb-3 fw-bold text-primary">Lot ${lot} - Chemical Analysis</h5>
          <div class="mb-3">
            <label for="heatNo_${lot}" class="form-label fw-semibold">Heat No.</label>
            <input type="text" id="heatNo_${lot}" class="form-control" placeholder="Enter Heat Number">
          </div>
          <div class="table-responsive">
            <table class="table table-bordered align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>Element</th>
                  <th>Specified Range</th>
                  <th>Sample 1</th>
                  <th>Sample 2</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>%C</td>
                  <td>0.50 - 0.60</td>
                  <td><input type="number" step="0.001" class="form-control chem-input" data-element="C" data-lot="${lot}" data-sample="1"></td>
                  <td><input type="number" step="0.001" class="form-control chem-input" data-element="C" data-lot="${lot}" data-sample="2"></td>
                </tr>
                <tr>
                  <td>%Si</td>
                  <td>1.50 - 2.00</td>
                  <td><input type="number" step="0.001" class="form-control chem-input" data-element="Si" data-lot="${lot}" data-sample="1"></td>
                  <td><input type="number" step="0.001" class="form-control chem-input" data-element="Si" data-lot="${lot}" data-sample="2"></td>
                </tr>
                <tr>
                  <td>%Mn</td>
                  <td>0.80 - 1.00</td>
                  <td><input type="number" step="0.001" class="form-control chem-input" data-element="Mn" data-lot="${lot}" data-sample="1"></td>
                  <td><input type="number" step="0.001" class="form-control chem-input" data-element="Mn" data-lot="${lot}" data-sample="2"></td>
                </tr>
                <tr>
                  <td>%P</td>
                  <td>0.030 Max</td>
                  <td><input type="number" step="0.001" class="form-control chem-input" data-element="P" data-lot="${lot}" data-sample="1"></td>
                  <td><input type="number" step="0.001" class="form-control chem-input" data-element="P" data-lot="${lot}" data-sample="2"></td>
                </tr>
                <tr>
                  <td>%S</td>
                  <td>0.030 Max</td>
                  <td><input type="number" step="0.001" class="form-control chem-input" data-element="S" data-lot="${lot}" data-sample="1"></td>
                  <td><input type="number" step="0.001" class="form-control chem-input" data-element="S" data-lot="${lot}" data-sample="2"></td>
                </tr>
                <tr>
                  <td>Grain Size</td>
                  <td>Criteria</td>
                  <td><input type="number" step="0.01" class="form-control chem-input" data-element="Grain Size" data-lot="${lot}" data-sample="1"></td>
                  <td><input type="number" step="0.01" class="form-control chem-input" data-element="Grain Size" data-lot="${lot}" data-sample="2"></td>
                </tr>
                <tr>
                  <td>Inclusion Rating</td>
                  <td>Criteria</td>
                  <td><input type="number" step="0.01" class="form-control chem-input" data-element="IR" data-lot="${lot}" data-sample="1"></td>
                  <td><input type="number" step="0.01" class="form-control chem-input" data-element="IR" data-lot="${lot}" data-sample="2"></td>
                </tr>
                <tr>
                  <td>Hardness BHN/HRC</td>
                  <td>Criteria</td>
                  <td><input type="number" step="0.01" class="form-control chem-input" data-element="HRC" data-lot="${lot}" data-sample="1"></td>
                  <td><input type="number" step="0.01" class="form-control chem-input" data-element="HRC" data-lot="${lot}" data-sample="2"></td>
                </tr>
                <tr>
                  <td>Depth of Decarb</td>
                  <td>Criteria</td>
                  <td><input type="number" step="0.01" class="form-control chem-input" data-element="Decarb" data-lot="${lot}" data-sample="1"></td>
                  <td><input type="number" step="0.01" class="form-control chem-input" data-element="Decarb" data-lot="${lot}" data-sample="2"></td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
        tablesContainer.appendChild(table);
      }

      addValidationListeners();
    });

    function addValidationListeners() {
      document.querySelectorAll('.chem-input').forEach(input => {
        input.addEventListener('input', () => {
          const element = input.dataset.element;
          const value = parseFloat(input.value);
          let outOfRange = false;

          if (tolerance[element]) {
            const t = tolerance[element];
            if (t.min !== undefined && t.max !== undefined) {
              outOfRange = value < t.min || value > t.max;
            } else if (t.max !== undefined) {
              outOfRange = value > t.max;
            }
          }

          if (outOfRange) {
            input.classList.add('out-of-range');
          } else {
            input.classList.remove('out-of-range');
          }
        });
      });
    }

    // 💾 Submit data
    document.getElementById('submitChemical').addEventListener('click', () => {
      const lotCount = parseInt(lotInput.value) || 0;
      const remarks = document.getElementById('remarks').value;
      const result = [];

      for (let lot = 1; lot <= lotCount; lot++) {
        const lotData = { lot, readings: [] };
        ['C','Si','Mn','P','S'].forEach(el => {
          const s1 = parseFloat(document.querySelector(`.chem-input[data-element="${el}"][data-lot="${lot}"][data-sample="1"]`)?.value) || null;
          const s2 = parseFloat(document.querySelector(`.chem-input[data-element="${el}"][data-lot="${lot}"][data-sample="2"]`)?.value) || null;
          lotData.readings.push({ element: el, sample1: s1, sample2: s2 });
        });
        result.push(lotData);
      }

      console.log('✅ Chemical Analysis Data:', { result, remarks });
      alert('✅ Chemical Analysis Data saved successfully!');
      window.location.href = '/sarthi/pages/erc_raw_material_inspection_dashboard.html';
    });

    // ✅ Set default lots to 1 and trigger table rendering
    window.addEventListener('DOMContentLoaded', () => {
      lotInput.value = 1;
      lotInput.dispatchEvent(new Event('input'));
    });
  </script>
</body>
</html>
