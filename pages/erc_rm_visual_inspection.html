<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SARTHI - ERC Raw Material Visual & Dimensional Inspection</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- AOS -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <link href="../assets/css/styles.css" rel="stylesheet">

  <style>
    .page-content {
      padding-bottom: 5rem; /* Prevent footer overlap */
    }
    .form-container {
      max-width: 900px;
      margin: 0 auto;
    }
    table input {
      text-align: center;
    }
    .out-of-range {
      background-color: #f8d7da !important;  /* Light red background */
      border-color: #f5c2c7 !important;
      color: #842029;
    }
    /* 🔥 Auto-populated heat number indicator */
    .auto-populated {
      background-color: #d1ecf1 !important;
      border-color: #bee5eb !important;
    }
    .heat-number-badge {
      display: inline-block;
      background-color: #0dcaf0;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-left: 8px;
      font-weight: 600;
    }
    /* 🔥 Auto-populated Std. Dia indicator */
    .std-dia-badge {
      display: inline-block;
      background-color: #198754;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-left: 8px;
      font-weight: 600;
    }
    .auto-populated-select {
      background-color: #d1f4dd !important;
      border-color: #badbcc !important;
    }
    /* 🔥 Observation checkboxes styling */
    .observation-checkboxes {
      background-color: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }
    .observation-checkboxes .form-check {
      margin-bottom: 8px;
    }
    .observation-checkboxes .form-check:last-child {
      margin-bottom: 0;
    }
    .observation-checkboxes .form-check-input:checked {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .observation-checkboxes .form-check-label {
      font-size: 14px;
      color: #495057;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- ✅ Navbar -->
  <div id="navbar-container"></div>

  <!-- 🧾 Main Content -->
  <div class="container page-content py-4">
    <div class="form-container">
      <h1 class="h3 mb-4 text-center" data-aos="fade-up">
        ERC - Raw Material Visual Inspection
      </h1>

      <div class="card shadow-sm" data-aos="fade-up" data-aos-delay="100">
        <div class="card-body p-4">

          <!-- 📌 Section: Requirement -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Requirement</label>
            <div class="alert alert-light border">
              Surface of the as rolled bars should be reasonably smooth, free from distortion, twist & kinks and shall be substantially straight.
              The bars shall be free from harmful defects namely folds, laps, cracks, deep pits, grooves, excessive scaling which may lead to cracking during hardening or impair serviceability.
              Bars shall be free from internal defects, such as piping, segregation which may impair serviceability.
            </div>
          </div>

          <!-- 📚 Section: Reference -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Reference</label>
            <div class="alert alert-info mb-0">
              Ref Cl. No. 4.8 of IRS T-31-2025 (Two Samples per Heat)
            </div>
          </div>

          <!-- 🧪 Section: Samples -->
          <div class="mb-4">
            <label for="sampleCount" class="form-label fw-semibold">Samples to be Taken</label>
            <input type="number" class="form-control" id="sampleCount" value="1" min="1">
          </div>

          <!-- 👀 Section: Observations -->
          <div id="observationsContainer" class="mb-4"></div>

          <!-- 📐 Std. Diameter Selection -->
          <div class="mb-4">
            <label for="stdDia" class="form-label fw-semibold">
              Std. Dia
              <span class="std-dia-badge" id="stdDiaBadge" style="display: none;">Auto-filled</span>
            </label>
            <select id="stdDia" class="form-select">
              <option value="" selected disabled>Select Std. Dia</option>
              <option value="20.64">20.64 mm</option>
              <option value="23">23 mm</option>
            </select>
            <small class="text-muted" id="stdDiaHelpText"></small>
          </div>

          <!-- 📏 Section: Sample Diameter Table -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Sample Diameter Measurement</label>
            <div id="tablesContainer"></div>
          </div>

          <!-- 📝 Remarks -->
          <div class="mb-4">
            <label for="remarks" class="form-label fw-semibold">Remarks</label>
            <textarea class="form-control" id="remarks" rows="3" placeholder="Enter any remarks..."></textarea>
          </div>

          <!-- 💾 Submit Button -->
          <div class="d-flex justify-content-center">
            <button type="button" class="btn btn-primary px-5" id="submitInspection">
              Save Visual & Dimensional Inspection
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- 📌 Footer -->
  <footer class="border-top py-3 mt-4 text-center small text-muted">
    © SARTHI - QIMS — v0.1
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    AOS.init({ duration: 800, once: true });

    const sampleInput = document.getElementById('sampleCount');
    const observationsContainer = document.getElementById('observationsContainer');
    const tablesContainer = document.getElementById('tablesContainer');
    const stdDiaSelect = document.getElementById('stdDia');
    const stdDiaBadge = document.getElementById('stdDiaBadge');
    const stdDiaHelpText = document.getElementById('stdDiaHelpText');

    let toleranceMin = null;
    let toleranceMax = null;

    // 🔥 Product Type to Standard Diameter Mapping
    const productTypeToDiameter = {
      'MK III': '20.64',
      'MK V': '23'
    };

    // 🔥 Load inspection data from sessionStorage and auto-populate Std. Dia
    function loadAndPopulateStdDia() {
      const inspectionDataStr = sessionStorage.getItem('inspectionStartData');
      if (inspectionDataStr) {
        try {
          const inspectionData = JSON.parse(inspectionDataStr);
          const productType = inspectionData.productType;

          if (productType && productTypeToDiameter[productType]) {
            const stdDiaValue = productTypeToDiameter[productType];
            stdDiaSelect.value = stdDiaValue;

            // Add visual indicators
            stdDiaSelect.classList.add('auto-populated-select');
            stdDiaBadge.style.display = 'inline-block';
            stdDiaHelpText.textContent = `Auto-filled based on product type: ${productType}`;
            stdDiaHelpText.classList.add('text-success');

            // Trigger change event to update tolerances
            stdDiaSelect.dispatchEvent(new Event('change'));

            // Show notification
            showStdDiaNotification(productType, stdDiaValue);

            console.log(`✅ Auto-populated Std. Dia: ${stdDiaValue} mm (from ${productType})`);

            // Remove visual indicators when user changes the value
            stdDiaSelect.addEventListener('change', function removeIndicators() {
              stdDiaSelect.classList.remove('auto-populated-select');
              stdDiaBadge.style.display = 'none';
              stdDiaHelpText.textContent = '';
              stdDiaSelect.removeEventListener('change', removeIndicators);
            }, { once: true });
          }
        } catch (e) {
          console.error('Error loading inspection data:', e);
        }
      }
    }

    // 🔥 Show notification when Std. Dia is auto-populated
    function showStdDiaNotification(productType, diameter) {
      const notification = document.createElement('div');
      notification.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
      notification.style.zIndex = '9999';
      notification.style.maxWidth = '500px';
      notification.innerHTML = `
        <strong>✅ Standard Diameter Auto-filled!</strong><br>
        Std. Dia set to <strong>${diameter} mm</strong> based on product type <strong>${productType}</strong>.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(notification);

      // Auto-dismiss after 5 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    // 🔥 Call auto-populate on page load
    loadAndPopulateStdDia();

    // ✅ Update tolerance values based on selected Std. Dia
    stdDiaSelect.addEventListener('change', () => {
      const value = stdDiaSelect.value;
      if (value === '20.64') {
        toleranceMin = 20.47;
        toleranceMax = 20.84;
      } else if (value === '23') {
        toleranceMin = 22.81;
        toleranceMax = 23.23;
      } else {
        toleranceMin = null;
        toleranceMax = null;
      }
      validateAllDiaFields();
    });

    // 🔥 Load heat numbers from sessionStorage
    function loadHeatNumbersFromSession() {
      const savedHeatNumbers = sessionStorage.getItem('ercRawMaterialHeatNumbers');
      if (savedHeatNumbers) {
        try {
          return JSON.parse(savedHeatNumbers);
        } catch (e) {
          console.error('Error parsing heat numbers from session:', e);
          return [];
        }
      }
      return [];
    }

    // Function to generate fields and table
    function generateFields(count) {
      observationsContainer.innerHTML = '';
      tablesContainer.innerHTML = '';

      // 🔥 Get saved heat numbers
      const savedHeatNumbers = loadHeatNumbersFromSession();

      for (let s = 1; s <= count; s++) {
        // Observation fields
        const div = document.createElement('div');
        div.className = 'mb-3';

        // 🔥 Auto-populate heat number if available
        const heatNumberValue = savedHeatNumbers[s - 1] || '';
        const isAutoPopulated = heatNumberValue !== '';
        const autoBadge = isAutoPopulated ? '<span class="heat-number-badge">Auto-filled</span>' : '';
        const autoClass = isAutoPopulated ? 'auto-populated' : '';

        div.innerHTML = `
          <label class="form-label fw-semibold">Heat Number ${s} ${autoBadge}</label>
          <input type="text" class="form-control mb-2 ${autoClass}" placeholder="Enter Heat No." id="hn-${s}" value="${heatNumberValue}">

          <label class="form-label fw-semibold">Observation for Sample ${s}</label>
          <div class="observation-checkboxes mb-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="obs-${s}-surface-cracks" value="Surface cracks">
              <label class="form-check-label" for="obs-${s}-surface-cracks">Surface cracks</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="obs-${s}-rust" value="Rust">
              <label class="form-check-label" for="obs-${s}-rust">Rust</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="obs-${s}-bending" value="Bending">
              <label class="form-check-label" for="obs-${s}-bending">Bending</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="obs-${s}-improper-marking" value="Improper marking">
              <label class="form-check-label" for="obs-${s}-improper-marking">Improper marking</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="obs-${s}-no-defect" value="No Defect">
              <label class="form-check-label" for="obs-${s}-no-defect">No Defect</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="obs-${s}-other" value="Other">
              <label class="form-check-label" for="obs-${s}-other">Other</label>
            </div>
          </div>

          <!-- Other remarks field (hidden by default) -->
          <div id="other-remarks-container-${s}" style="display: none;" class="mb-2">
            <label class="form-label fw-semibold text-muted small">Specify Other Defect:</label>
            <input type="text" class="form-control form-control-sm" id="other-remarks-${s}" placeholder="Enter reason for other defect">
          </div>
        `;
        observationsContainer.appendChild(div);

        // 🔥 Add event listener to show/hide "Other" remarks field
        setTimeout(() => {
          const otherCheckbox = document.getElementById(`obs-${s}-other`);
          const otherRemarksContainer = document.getElementById(`other-remarks-container-${s}`);

          otherCheckbox.addEventListener('change', function() {
            if (this.checked) {
              otherRemarksContainer.style.display = 'block';
            } else {
              otherRemarksContainer.style.display = 'none';
              document.getElementById(`other-remarks-${s}`).value = '';
            }
          });
        }, 100);

        // 🔥 Remove auto-populated styling when user edits the field
        if (isAutoPopulated) {
          setTimeout(() => {
            const heatInput = document.getElementById(`hn-${s}`);
            heatInput.addEventListener('input', function() {
              this.classList.remove('auto-populated');
            });
          }, 100);
        }

        // Table for each sample
        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-responsive mb-4';

        const table = document.createElement('table');
        table.className = 'table table-bordered align-middle text-center';
        table.innerHTML = `
          <thead class="table-light">
            <tr>
              <th colspan="4">Sample ${s} - Diameter Measurement</th>
            </tr>
            <tr>
              <th>Sample No.</th>
              <th>Dia (mm)</th>
              <th>Sample No.</th>
              <th>Dia (mm)</th>
            </tr>
          </thead>
          <tbody id="tableBody-${s}"></tbody>
        `;
        tableWrapper.appendChild(table);
        tablesContainer.appendChild(tableWrapper);

        const tbody = document.getElementById(`tableBody-${s}`);
        for (let i = 1; i <= 20; i += 2) {
          const secondSample = i + 1 <= 20 ? i + 1 : '';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i}</td>
            <td><input type="number" class="form-control text-center dia-field" id="dia-${s}-${i}" placeholder="mm"></td>
            <td>${secondSample || ''}</td>
            <td>${secondSample ? `<input type="number" class="form-control text-center dia-field" id="dia-${s}-${secondSample}" placeholder="mm">` : ''}</td>
          `;
          tbody.appendChild(tr);
        }
      }
      attachValidationListeners();

      // 🔥 Show notification if heat numbers were auto-populated
      if (savedHeatNumbers.length > 0) {
        showHeatNumberNotification(savedHeatNumbers.length);
      }
    }

    // 🔥 Show notification when heat numbers are auto-populated
    function showHeatNumberNotification(count) {
      const notification = document.createElement('div');
      notification.className = 'alert alert-info alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
      notification.style.zIndex = '9999';
      notification.style.maxWidth = '500px';
      notification.innerHTML = `
        <strong>✅ Heat Numbers Auto-filled!</strong><br>
        ${count} heat number${count > 1 ? 's' : ''} automatically populated from the dashboard.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(notification);

      // Auto-dismiss after 5 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    // Generate initial fields with default value = 1
    generateFields(1);

    // Regenerate when sample count changes
    sampleInput.addEventListener('input', () => {
      const count = parseInt(sampleInput.value) || 1;
      generateFields(count);
    });

    // Attach listeners to all dia fields
    function attachValidationListeners() {
      document.querySelectorAll('.dia-field').forEach(input => {
        input.addEventListener('input', () => validateDiaField(input));
      });
    }

    // Validate a single dia field
    function validateDiaField(input) {
      const val = parseFloat(input.value);
      if (toleranceMin !== null && toleranceMax !== null && !isNaN(val)) {
        if (val < toleranceMin || val > toleranceMax) {
          input.classList.add('out-of-range');
        } else {
          input.classList.remove('out-of-range');
        }
      } else {
        input.classList.remove('out-of-range');
      }
    }

    // Validate all dia fields
    function validateAllDiaFields() {
      document.querySelectorAll('.dia-field').forEach(input => validateDiaField(input));
    }

    // Submit
    document.getElementById('submitInspection').addEventListener('click', () => {
      const sampleCount = parseInt(sampleInput.value) || 1;
      const remarks = document.getElementById('remarks').value;
      const allData = [];

      for (let s = 1; s <= sampleCount; s++) {
        const heat = document.getElementById(`hn-${s}`).value || '';

        // 🔥 Collect observation checkboxes
        const observations = [];
        const checkboxes = [
          { id: `obs-${s}-surface-cracks`, label: 'Surface cracks' },
          { id: `obs-${s}-rust`, label: 'Rust' },
          { id: `obs-${s}-bending`, label: 'Bending' },
          { id: `obs-${s}-improper-marking`, label: 'Improper marking' },
          { id: `obs-${s}-no-defect`, label: 'No Defect' },
          { id: `obs-${s}-other`, label: 'Other' }
        ];

        checkboxes.forEach(cb => {
          const checkbox = document.getElementById(cb.id);
          if (checkbox && checkbox.checked) {
            if (cb.label === 'Other') {
              const otherRemarks = document.getElementById(`other-remarks-${s}`).value || '';
              observations.push(`Other: ${otherRemarks}`);
            } else {
              observations.push(cb.label);
            }
          }
        });

        const obs = observations.length > 0 ? observations.join(', ') : 'No observations recorded';
        const diaData = [];

        for (let i = 1; i <= 10; i++) {
          const val = document.getElementById(`dia-${s}-${i}`).value || '';
          diaData.push({ row: i, dia: val });
        }

        allData.push({ sample: s, heat, observation: obs, diameters: diaData });
      }

      const inspectionData = {
        sampleCount,
        stdDia: stdDiaSelect.value,
        tolerance: { min: toleranceMin, max: toleranceMax },
        data: allData,
        remarks
      };

      console.log('✅ Visual Inspection Data:', inspectionData);
      alert('✅ Visual Inspection data saved successfully!');
      window.location.href = '/sarthi/pages/erc_raw_material_inspection_dashboard.html';
    });
  </script>
</body>
</html>
