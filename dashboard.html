<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SARTHI - Railway Inspection Dashboard</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- AOS -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <!-- Custom CSS -->
  <link href="assets/css/styles.css" rel="stylesheet">
  
  <style>
    .monthly-data-table {
      margin-top: 2rem;
    }
    .monthly-data-table table {
      font-size: 0.95rem;
    }
    .monthly-data-table th {
      background-color: #0d6efd;
      color: white;
      font-weight: 600;
      text-align: center;
      vertical-align: middle;
      padding: 12px 8px;
    }
    .monthly-data-table td {
      text-align: center;
      vertical-align: middle;
      padding: 10px 8px;
    }
    .monthly-data-table td:first-child {
      text-align: left;
      font-weight: 600;
      background-color: #f8f9fa;
    }
    .rejection-low {
      background-color: #d4edda;
      color: #155724;
      font-weight: 600;
    }
    .rejection-medium {
      background-color: #fff3cd;
      color: #856404;
      font-weight: 600;
    }
    .rejection-high {
      background-color: #f8d7da;
      color: #721c24;
      font-weight: 600;
    }
  </style>
</head>
<body>


  <!-- ‚úÖ Navbar Component -->
  <div id="navbar-container"></div>

  <!-- Main Container -->
  <div class="container-fluid py-4">
    <div class="row">
      <!-- Main Content -->
      <main id="content" class="col-12">
        <h1 class="h3 mb-4" data-aos="fade-up">Dashboard</h1>

        <!-- Filters Section -->
        <div class="row mb-4" data-aos="fade-up" data-aos-delay="50">
          <div class="col-12 col-md-6 col-lg-3 mb-3">
            <label for="zonalRailwayFilter" class="form-label fw-semibold">Zonal Railway</label>
            <select class="form-select" id="zonalRailwayFilter">
              <option value="all" selected>All Zonal Railways</option>
              <option value="CR">Central Railway (CR)</option>
              <option value="ER">Eastern Railway (ER)</option>
              <option value="ECR">East Central Railway (ECR)</option>
              <option value="ECoR">East Coast Railway (ECoR)</option>
              <option value="NR">Northern Railway (NR)</option>
              <option value="NCR">North Central Railway (NCR)</option>
              <option value="NER">North Eastern Railway (NER)</option>
              <option value="NFR">Northeast Frontier Railway (NFR)</option>
              <option value="NWR">North Western Railway (NWR)</option>
              <option value="SR">Southern Railway (SR)</option>
              <option value="SCR">South Central Railway (SCR)</option>
              <option value="SECR">South East Central Railway (SECR)</option>
              <option value="SER">South Eastern Railway (SER)</option>
              <option value="SWR">South Western Railway (SWR)</option>
              <option value="WR">Western Railway (WR)</option>
              <option value="WCR">West Central Railway (WCR)</option>
              <option value="Metro">Metro Railway (Kolkata)</option>
            </select>
          </div>
          <div class="col-12 col-md-6 col-lg-3 mb-3">
            <label for="ritesOfficeFilter" class="form-label fw-semibold">RITES Regional Office</label>
            <select class="form-select" id="ritesOfficeFilter">
              <option value="all" selected>All Regional Offices</option>
              <option value="delhi">NRIO</option>
              <option value="mumbai">WRIO</option>
              <option value="kolkata">ERIO</option>
              <option value="chennai">SRIO</option>
              <option value="bangalore">CRIO</option>
            </select>
          </div>
        </div>

        <div class="mb-4" data-aos="fade-up" data-aos-delay="100">
          <div class="btn-group flex-wrap" role="group" aria-label="Product Toggle Buttons">
            <input type="radio" class="btn-check" name="productToggle" id="btnERC" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="btnERC">ERC</label>

            <input type="radio" class="btn-check" name="productToggle" id="btnSleeper" autocomplete="off">
            <label class="btn btn-outline-primary" for="btnSleeper">Sleeper</label>

            <input type="radio" class="btn-check" name="productToggle" id="btnRubberPad" autocomplete="off">
            <label class="btn btn-outline-primary" for="btnRubberPad">GRSP</label>

            <input type="radio" class="btn-check" name="productToggle" id="btnElastomeric" autocomplete="off">
            <label class="btn btn-outline-primary" for="btnElastomeric">Elastomeric Pad</label>

            <input type="radio" class="btn-check" name="productToggle" id="btnRail" autocomplete="off">
            <label class="btn btn-outline-primary" for="btnRail">Rail</label>
          </div>
        </div>

        <!-- KPI Cards - Dual Metrics (PO Count & Quantity) -->
        <div class="row g-4 mb-4">
          <!-- Card 1: PO Placed / Qty Offered -->
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card hover-lift border-primary" style="border-left: 4px solid #0d6efd;">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h6 class="card-subtitle text-muted mb-0">PO Placed / Qty Offered</h6>
                  <div class="fs-3">üì¶</div>
                </div>
                <div class="row">
                  <div class="col-6">
                    <p class="text-muted mb-1 small">PO Count</p>
                    <h4 class="mb-0 text-primary" id="poPlaced">45</h4>
                  </div>
                  <div class="col-6">
                    <p class="text-muted mb-1 small">Qty Offered</p>
                    <h4 class="mb-0 text-primary" id="qtyOffered">5,200</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Card 2: PO Under Inspection / Qty Inspected -->
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card hover-lift border-warning" style="border-left: 4px solid #ffc107;">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h6 class="card-subtitle text-muted mb-0">PO Under Inspection / Qty Inspected</h6>
                  <div class="fs-3">üîç</div>
                </div>
                <div class="row">
                  <div class="col-6">
                    <p class="text-muted mb-1 small">PO Count</p>
                    <h4 class="mb-0 text-warning" id="poUnderInspection">18</h4>
                  </div>
                  <div class="col-6">
                    <p class="text-muted mb-1 small">Qty Inspected</p>
                    <h4 class="mb-0 text-warning" id="qtyInspected">3,444</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Card 3: PO Pending / Qty Accepted -->
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card hover-lift border-success" style="border-left: 4px solid #198754;">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h6 class="card-subtitle text-muted mb-0">PO Pending / Qty Accepted</h6>
                  <div class="fs-3">‚è≥</div>
                </div>
                <div class="row">
                  <div class="col-6">
                    <p class="text-muted mb-1 small">PO Pending</p>
                    <h4 class="mb-0 text-info" id="poPending">12</h4>
                  </div>
                  <div class="col-6">
                    <p class="text-muted mb-1 small">Qty Accepted</p>
                    <h4 class="mb-0 text-success" id="qtyAccepted">3,000</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Card 4: PO Complete / Qty Rejected -->
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card hover-lift border-danger" style="border-left: 4px solid #dc3545;">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h6 class="card-subtitle text-muted mb-0">PO Complete / Qty Rejected</h6>
                  <div class="fs-3">‚úÖ</div>
                </div>
                <div class="row">
                  <div class="col-6">
                    <p class="text-muted mb-1 small">PO Complete</p>
                    <h4 class="mb-0 text-success" id="poComplete">15</h4>
                  </div>
                  <div class="col-6">
                    <p class="text-muted mb-1 small">Qty Rejected</p>
                    <h4 class="mb-0 text-danger" id="qtyRejected">444</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="row g-4 mt-2">
          <div class="col-12 col-lg-8" data-aos="fade-up" data-aos-delay="600">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title mb-4">üìä Monthly Inspection Results (Last 6 Months)</h5>
                <p id="chartSubtitle" class="text-muted small mb-3">
                  Accepted vs Rejected quantity (MT) by month for selected <strong>ERC</strong>
                </p>
                <canvas id="trendChart" height="80"></canvas>
                
                <!-- Monthly Data Table -->
                <div class="monthly-data-table">
                  <h6 class="mb-3">üìã Monthly Data Summary</h6>
                  <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                      <thead>
                        <tr>
                          <th style="text-align: left;">Metric</th>
                          <th>January</th>
                          <th>February</th>
                          <th>March</th>
                          <th>April</th>
                          <th>May</th>
                          <th>June</th>
                        </tr>
                      </thead>
                      <tbody id="monthlyDataTableBody">
                        <!-- Data will be populated by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-4" data-aos="fade-up" data-aos-delay="700">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title mb-4">üìâ Rejection by Inspection Stage</h5>
                <p class="text-muted small mb-3">Distribution of rejected quantity (MT) across stages</p>
                <canvas id="statusChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Footer -->
  <footer class="border-top py-3 mt-4 text-center small text-muted">
    ¬© SARTHI - QIMS ‚Äî v0.1
  </footer>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <!-- App JS -->
  <script src="assets/js/app.js"></script>

  <script>
  // Page Loader
  window.addEventListener('load', () => {
    const loader = document.getElementById('pageLoader');
    if (loader) {
      setTimeout(() => {
        loader.style.opacity = '0';
        setTimeout(() => loader.style.display = 'none', 500);
      }, 1000);
    }
  });

  // AOS Init
  AOS.init({ duration: 800, once: true });

  // ================================
  // üìä Chart Data for Each Product
  // ================================
  const chartDataSets = {
    ERC: {
      // Monthly quantities [Jan, Feb, Mar, Apr, May, Jun] in MT
      accepted: [850, 920, 780, 890, 810, 750],
      rejected: [35, 42, 28, 48, 38, 52], // 3.96%, 4.37%, 3.46%, 5.11%, 4.48%, 6.48%
      // Stage-wise rejection in MT
      stageRejection: {
        raw: 85,      // 3.2% equivalent
        process: 77,  // 2.9% equivalent  
        final: 138    // 5.2% equivalent
      },
      kpi: {
        poPlaced: 45, qtyOffered: 5200,
        poUnderInspection: 18, qtyInspected: 3444,
        poPending: 12, qtyAccepted: 3000,
        poComplete: 15, qtyRejected: 444
      }
    },
    Sleeper: {
      accepted: [720, 650, 740, 680, 710, 690],
      rejected: [52, 78, 46, 100, 88, 84], // 6.73%, 10.71%, 5.85%, 12.82%, 11.02%, 10.85%
      stageRejection: {
        raw: 180,     // 6.7%
        process: 158, // 5.9%
        final: 112    // 4.2%
      },
      kpi: {
        poPlaced: 38, qtyOffered: 4200,
        poUnderInspection: 15, qtyInspected: 2800,
        poPending: 10, qtyAccepted: 2600,
        poComplete: 13, qtyRejected: 200
      }
    },
    GRSP: {
      accepted: [410, 380, 420, 390, 410, 400],
      rejected: [28, 32, 30, 52, 38, 35], // 6.40%, 7.77%, 6.67%, 11.76%, 8.48%, 8.05%
      stageRejection: {
        raw: 75,     // 4.4%
        process: 51, // 3.0%
        final: 87    // 5.1%
      },
      kpi: {
        poPlaced: 28, qtyOffered: 2500,
        poUnderInspection: 11, qtyInspected: 1900,
        poPending: 8, qtyAccepted: 1700,
        poComplete: 9, qtyRejected: 200
      }
    },
    'Elastomeric Pad': {
      accepted: [280, 260, 270, 290, 275, 285],
      rejected: [40, 44, 45, 34, 39, 40], // 12.50%, 14.47%, 14.29%, 10.49%, 12.42%, 12.31%
      stageRejection: {
        raw: 123,    // 6.1%
        process: 50, // 2.5%
        final: 95    // 4.7%
      },
      kpi: {
        poPlaced: 22, qtyOffered: 1800,
        poUnderInspection: 9, qtyInspected: 1500,
        poPending: 6, qtyAccepted: 1300,
        poComplete: 7, qtyRejected: 200
      }
    },
    Rail: {
      accepted: [1050, 1120, 1080, 1040, 1010, 1090],
      rejected: [79, 62, 73, 110, 125, 105], // 6.99%, 5.24%, 6.33%, 9.57%, 11.01%, 8.79%
      stageRejection: {
        raw: 147,    // 3.5%
        process: 126, // 3.0%
        final: 109   // 2.6%
      },
      kpi: {
        poPlaced: 52, qtyOffered: 6500,
        poUnderInspection: 21, qtyInspected: 4200,
        poPending: 14, qtyAccepted: 4000,
        poComplete: 17, qtyRejected: 200
      }
    }
  };

  const months = ['January', 'February', 'March', 'April', 'May', 'June'];

  // ================================
  // üìà Initialize Charts
  // ================================
  let trendChartInstance = null;
  let statusChartInstance = null;

  function getRejectionClass(percentage) {
    if (percentage < 5) return 'rejection-low';
    if (percentage < 10) return 'rejection-medium';
    return 'rejection-high';
  }

  function updateMonthlyDataTable(product = 'ERC') {
    const productData = chartDataSets[product];
    const tableBody = document.getElementById('monthlyDataTableBody');
    
    // Build Lot Quantity row
    let lotQtyRow = '<tr><td>Lot Quantity (MT)</td>';
    for (let i = 0; i < 6; i++) {
      const lotQty = productData.accepted[i] + productData.rejected[i];
      lotQtyRow += `<td>${lotQty.toLocaleString()}</td>`;
    }
    lotQtyRow += '</tr>';
    
    // Build Rejection Percentage row
    let rejectionRow = '<tr><td>Rejection %</td>';
    for (let i = 0; i < 6; i++) {
      const accepted = productData.accepted[i];
      const rejected = productData.rejected[i];
      const lotQty = accepted + rejected;
      const rejectionPct = ((rejected / lotQty) * 100).toFixed(2);
      const rejectionClass = getRejectionClass(parseFloat(rejectionPct));
      rejectionRow += `<td class="${rejectionClass}">${rejectionPct}%</td>`;
    }
    rejectionRow += '</tr>';
    
    tableBody.innerHTML = lotQtyRow + rejectionRow;
  }

  function initCharts(product = 'ERC') {
    const trendCtx = document.getElementById('trendChart');
    const statusCtx = document.getElementById('statusChart');
    const productData = chartDataSets[product];
    const subtitle = document.getElementById('chartSubtitle');
      if (subtitle) {
        subtitle.innerHTML = `Accepted vs Rejected quantity (MT) by month for selected <strong>${product}</strong>`;
      }

    // Update monthly data table
    updateMonthlyDataTable(product);

    // ============================================
    // Stacked Bar Chart - Accepted vs Rejected
    // ============================================
    if (trendCtx) {
      if (trendChartInstance) trendChartInstance.destroy();
      trendChartInstance = new Chart(trendCtx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            {
              label: 'Accepted Quantity (MT)',
              data: productData.accepted,
              backgroundColor: 'rgba(40, 167, 69, 0.85)',
              borderColor: 'rgb(40, 167, 69)',
              borderWidth: 1,
              borderRadius: 5
            },
            {
              label: 'Rejected Quantity (MT)',
              data: productData.rejected,
              backgroundColor: 'rgba(220, 53, 69, 0.85)',
              borderColor: 'rgb(220, 53, 69)',
              borderWidth: 1,
              borderRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            x: {
              stacked: true,
              grid: { display: false },
              ticks: {
                font: { size: 12, weight: '600' },
                color: '#495057'
              },
              title: {
                display: true,
                text: 'Month',
                font: { size: 14, weight: 'bold' },
                color: '#212529',
                padding: { top: 10 }
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              grid: { 
                color: 'rgba(0,0,0,0.06)',
                drawBorder: false
              },
              ticks: {
                font: { size: 12, weight: '600' },
                color: '#495057',
                callback: function(value) {
                  return value + ' MT';
                }
              },
              title: {
                display: true,
                text: 'Quantity (Metric Tons)',
                font: { size: 14, weight: 'bold' },
                color: '#212529',
                padding: { bottom: 10 }
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                padding: 20,
                boxWidth: 15,
                boxHeight: 15,
                font: { size: 13, weight: 'bold' },
                color: '#212529',
                usePointStyle: true,
                pointStyle: 'rectRounded'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.85)',
              titleFont: { weight: 'bold', size: 14 },
              bodyFont: { size: 13 },
              padding: 14,
              cornerRadius: 8,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.parsed.y;
                  const total = productData.accepted[context.dataIndex] + productData.rejected[context.dataIndex];
                  const percentage = ((value / total) * 100).toFixed(2);
                  return label + ': ' + value + ' MT (' + percentage + '%)';
                },
                footer: function(tooltipItems) {
                  const index = tooltipItems[0].dataIndex;
                  const total = productData.accepted[index] + productData.rejected[index];
                  return 'Total: ' + total + ' MT';
                }
              }
            }
          }
        }
      });
    }

    // ============================================
    // Doughnut Chart - Stage-wise Rejection with MT
    // ============================================
    if (statusCtx) {
      if (statusChartInstance) statusChartInstance.destroy();
      
      const stageData = [
        productData.stageRejection.raw,
        productData.stageRejection.process,
        productData.stageRejection.final
      ];
      const totalRejection = stageData.reduce((a, b) => a + b, 0);
      const percentages = stageData.map(val => ((val / totalRejection) * 100).toFixed(1));

      statusChartInstance = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['Raw Material Stage', 'Process Stage', 'Final Inspection Stage'],
          datasets: [{
            label: 'Rejected Quantity',
            data: stageData,
            backgroundColor: [
              'rgba(102, 126, 234, 0.9)',
              'rgba(255, 193, 7, 0.9)',
              'rgba(220, 53, 69, 0.9)'
            ],
            borderColor: [
              'rgb(102, 126, 234)',
              'rgb(255, 193, 7)',
              'rgb(220, 53, 69)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 18,
                boxWidth: 15,
                boxHeight: 15,
                font: { size: 12, weight: '600' },
                color: '#212529',
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.85)',
              titleFont: { weight: 'bold', size: 14 },
              bodyFont: { size: 13 },
              padding: 14,
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const percentage = percentages[context.dataIndex];
                  return label + ': ' + value + ' MT (' + percentage + '%)';
                }
              }
            },
            datalabels: {
              display: false
            }
          }
        },
        plugins: [{
          afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            const dataset = chart.data.datasets[0];
            const meta = chart.getDatasetMeta(0);
            
            meta.data.forEach(function(element, index) {
              ctx.save();
              ctx.fillStyle = '#ffffff';
              ctx.font = 'bold 12px Arial';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              
              const position = element.tooltipPosition();
              const value = stageData[index];
              const percentage = percentages[index];
              
              // Draw MT value
              ctx.fillText(value + ' MT', position.x, position.y - 8);
              // Draw percentage
              ctx.fillText('(' + percentage + '%)', position.x, position.y + 8);
              
              ctx.restore();
            });
          }
        }]
      });
    }

    // Update KPI Cards
    document.getElementById('poPlaced').textContent = productData.kpi.poPlaced;
    document.getElementById('qtyOffered').textContent = productData.kpi.qtyOffered.toLocaleString();
    document.getElementById('poUnderInspection').textContent = productData.kpi.poUnderInspection;
    document.getElementById('qtyInspected').textContent = productData.kpi.qtyInspected.toLocaleString();
    document.getElementById('poPending').textContent = productData.kpi.poPending;
    document.getElementById('qtyAccepted').textContent = productData.kpi.qtyAccepted.toLocaleString();
    document.getElementById('poComplete').textContent = productData.kpi.poComplete;
    document.getElementById('qtyRejected').textContent = productData.kpi.qtyRejected.toLocaleString();
  }

  // Initialize with ERC as default
  window.addEventListener('load', () => initCharts('ERC'));

  // ================================
  // üñ±Ô∏è Handle Product Toggle Buttons
  // ================================
  document.querySelectorAll('input[name="productToggle"]').forEach(btn => {
    btn.addEventListener('change', (e) => {
      if (e.target.checked) {
        const product = e.target.nextElementSibling.textContent.trim();
        console.log(`‚úÖ Selected Product: ${product}`);
        initCharts(product);
      }
    });
  });

  // ================================
  // üîç Handle Filter Dropdowns
  // ================================
  document.getElementById('zonalRailwayFilter').addEventListener('change', (e) => {
    const selectedZone = e.target.value;
    console.log(`üöÇ Zonal Railway Filter: ${selectedZone}`);
    // In a real application, this would filter the data
    // For now, we'll just log the selection
    if (selectedZone !== 'all') {
      console.log(`Filtering data for ${selectedZone}`);
      // You can add logic here to filter chartDataSets based on zone
    }
  });

  document.getElementById('ritesOfficeFilter').addEventListener('change', (e) => {
    const selectedOffice = e.target.value;
    console.log(`üè¢ RITES Office Filter: ${selectedOffice}`);
    // In a real application, this would filter the data
    // For now, we'll just log the selection
    if (selectedOffice !== 'all') {
      console.log(`Filtering data for ${selectedOffice} office`);
      // You can add logic here to filter chartDataSets based on office
    }
  });
</script>

</body>
</html>